

|              | note                                                                                                                                                                                                                                                                                                                                                                                                                  |
| ------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| PVC Template | - 在 StatefulSet 中不能直接声明 PVC，因为 PVC 是和 Pod 绑定的，STS 中配置的，其实是 PVC Template                                                                                                                                                                                                                                                                                                                                               |
| PVC          | - 在 StatefulSet 调度每一个 Pod 时，会按照 PVC Template 创建出 PVC<br>- PVC 会被 CSI Controller Driver 的 **external-provisioner** 负责侦听，调用 CSI Controller Driver 的 **CreateVolume** 接口创建 PV<br>- 对于 CSI Controller Driver 的开发者来讲，不需要关注 PVC 的 Reconcile 逻辑，这是属于 external-provsioner 的工作，external-provisioner 会调用 CSI Controller Driver 的 gRPC 接口<br>- **external-provisioner** 通常部署在 **CSI Controller Plugin** 部署在同一个 pod 中，作为 sidecar； |
| PV           | - PV 在创建时，可能关联到一个节点上<br>- 之后调度器会根据 PV 去调度 pod 到节点，kube-controller-manager 会创建出 VolumeAttachment CR<br>- **external-attacher** 会侦听 VolumeAttachment CR，调用 CSI Driver 的 **ControllerPublishVolume** 方法，将 PV attach 到这个 node<br>- kubelet 发现 VolumeAttachment 已经处于 attached 状态之后，通过 **CSI Node Plugin** 的 **NodeStageVolume** 进行设备文件初始化、通过 **NodePublishVolume** 方法进行 mount；                                             |
|              |                                                                                                                                                                                                                                                                                                                                                                                                                       |
|              |                                                                                                                                                                                                                                                                                                                                                                                                                       |
|              |                                                                                                                                                                                                                                                                                                                                                                                                                       |


![[2025-11-29-csi.excalidraw]]

